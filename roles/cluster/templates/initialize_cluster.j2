#!/bin/bash

host_string="{% for host in groups['all'] %} cluster meet {{ hostvars[host]['inventory_hostname'] }} {{ redis_port[0] }} \n {% endfor %} {% for host in groups['all'] %} cluster meet {{ hostvars[host]['inventory_hostname'] }} {{ redis_port[1] }} \n {% endfor %}"
echo -e $host_string | redis-cli -p 6379

redis-cli -h 192.168.2.111 -p 6379 cluster addslots {0..5461}
redis-cli -h 192.168.2.112 -p 6379 cluster addslots {5462..10922}
redis-cli -h 192.168.2.113 -p 6379 cluster addslots {10923..16383}

redis-cli cluster nodes
slave_node_ip_array=(`redis-cli cluster nodes | grep {{ redis_port[1] }} | awk '{print $2}' | cut -d ":" -f 1`)
master_node_ip_array=(`redis-cli cluster nodes | grep {{ redis_port[0] }} | awk '{print $2}' | cut -d ":" -f 1`)
master_node_id_array=(`redis-cli cluster nodes | grep {{ redis_port[0] }} | awk '{print $1}'`)

while true
do
    handshake_array=(`redis-cli cluster nodes | grep handshake`)
    if [ ${#handshake_array[@]} -eq 0 ]
    then
      echo handshake_array size = 0
      break
    fi
    echo handshake_array size > 0, sleep 1s
    sleep 1
done

{% raw %}
for((i=0;i<${#master_node_ip_array[@]};i++))
{% endraw %}
do
  if [ ${master_node_ip_array[`expr $i + 1`]} ]
  then
    echo ${master_node_ip_array[$i]}
    echo ${master_node_ip_array[`expr $i + 1`]}
    redis-cli -h ${master_node_ip_array[`expr $i + 1`]} -p 6380 cluster replicate ${master_node_id_array[$i]}
  else
    echo ${master_node_ip_array[$i]}
    echo ${master_node_ip_array[0]}
    redis-cli -h ${master_node_ip_array[0]} -p 6380 cluster replicate ${master_node_id_array[$i]}
  fi
done


